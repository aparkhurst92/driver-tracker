<script>
  const WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/25958410/ugzl230/";

  let trackingInterval = null;
  let isTracking = false;

  function startTracking() {
    const driverName = document.getElementById("driverName").value.trim();

    if (!driverName) {
      showStatus("Please enter your name first", "error");
      return;
    }

    if (isTracking) {
      showStatus("Already tracking...", "waiting");
      return;
    }

    isTracking = true;
    showStatus("Starting GPS tracking...", "waiting");
    document.querySelector(".start-btn").disabled = true;

    sendLocation(driverName);

    trackingInterval = setInterval(() => {
      sendLocation(driverName);
    }, 30000);
  }

  function stopTracking() {
    if (trackingInterval) clearInterval(trackingInterval);
    trackingInterval = null;
    isTracking = false;
    document.querySelector(".start-btn").disabled = false;
    showStatus("Tracking stopped", "error");
    document.getElementById("coords").style.display = "none";
  }

  function sendLocation(driverName) {
    if (!navigator.geolocation) {
      showStatus("Geolocation not supported", "error");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude, accuracy } = position.coords;

        // Zapier-friendly payload (form-encoded)
        const payload = new URLSearchParams({
          driver_name: driverName,
          latitude: latitude.toFixed(6),
          longitude: longitude.toFixed(6),
          accuracy_m: Math.round(accuracy),
          timestamp: new Date().toISOString(),
          address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`
        });

        try {
          await fetch(WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
            body: payload.toString()
          });

          showStatus("âœ… Location sent to Zapier", "active");
          document.getElementById("coords").innerHTML =
            `ðŸ“ ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (Â±${Math.round(accuracy)}m)`;
          document.getElementById("coords").style.display = "block";
        } catch (e) {
          showStatus("âŒ Could not send to Zapier", "error");
        }
      },
      (error) => {
        showStatus(`GPS Error: ${error.message}. Enable location.`, "error");
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  }

  function showStatus(message, type) {
    const status = document.getElementById("status");
    status.textContent = message;
    status.className = `status ${type}`;
  }
</script>

